<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Tickets</title>

<style>
  :root{
    --bg:#f5f7fb; --panel:#111; --text:#fff; --muted:#cbd5e1;
    --green:#18a058; --amber:#f59e0b; --red:#e11d48; --ink:#0f172a;
    --cell:#ffffff; --cellBorder:#d1d5db; --on:#111; --no:#9ca3af; --printed:#16a34a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
  h1{font-size:clamp(26px,4.5vw,34px);text-align:center;margin:16px 0 8px}
  .ranges{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;max-width:980px;margin:0 auto 14px;padding:0 16px}
  .ranges button{padding:12px 16px;border-radius:14px;border:0;background:#eaeef5;color:#0b57d0;font-weight:800;font-size:18px}
  .ranges button.active{background:#111;color:#fff}
  .panel{max-width:980px;margin:10px auto;padding:22px;border-radius:22px;background:var(--panel);color:var(--text)}
  .now{display:flex;flex-direction:column;align-items:center;gap:8px}
  .now h2{margin:0;font-size:clamp(22px,4vw,28px);font-weight:900}
  .big{font-size:clamp(64px,14vw,110px);font-weight:900;line-height:1}
  .mrn{font-size:clamp(16px,3.3vw,20px);opacity:.85;min-height:1.2em}
  .btns{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .btn{border:0;border-radius:14px;padding:12px 22px;font-weight:900;font-size:18px;cursor:pointer}
  .next{background:var(--green);color:#fff}
  .noshow{background:var(--amber);color:#111}
  .reset{background:var(--red);color:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(64px,1fr));gap:10px;max-width:980px;margin:14px auto 28px;padding:0 16px}
  .cell{border:2px solid var(--cellBorder);border-radius:14px;padding:14px 0;text-align:center;font-weight:800;font-size:18px;background:var(--cell);cursor:pointer;user-select:none;transition:.15s}
  .cell.on{background:var(--on);color:#fff;border-color:#000}
  .cell.no{background:var(--no);color:#fff;border-color:#888}
  .cell.printed{background:var(--printed);color:#fff;border-color:#0f7a34}
  .tip{max-width:980px;margin:0 auto 22px;padding:0 16px;color:#475569;text-align:center}
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Cardiac Tickets</h1>

  <div class="ranges" id="ranges"></div>

  <div class="panel">
    <div class="now">
      <h2>Now Serving</h2>
      <div class="big" id="nowNum">-</div>
      <div class="mrn" id="nowMrn"></div>
      <div class="btns">
        <button class="btn next"   id="btnNext">Next</button>
        <button class="btn noshow" id="btnNo">No Show</button>
        <button class="btn reset"  id="btnReset">Restart</button>
      </div>
    </div>
  </div>

  <div id="grid" class="grid"></div>

  <p class="tip">
    Tip: green = existing patient (printed), black = served patient, gray = no-show. Double-click a black cell to clear it, or press Restart to clear all.
  </p>

<script>
(function(){
  // Firebase
  const cfg={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
  firebase.initializeApp(cfg);
  const db=firebase.database();
  const ROOT="cardiac";

  const gridEl=document.getElementById("grid");
  const nowNum=document.getElementById("nowNum");
  const nowMrn=document.getElementById("nowMrn");

  // Build ranges 1..1000
  const rangesEl=document.getElementById("ranges");
  const ranges=[];
  for(let s=1;s<=1000;s+=100){ ranges.push([s,s+99]); }
  ranges.forEach(([a,b],i)=>{
    const btn=document.createElement("button");
    btn.textContent=`${a}â€“${b}`;
    btn.onclick=()=>showRange(a,b,btn);
    rangesEl.appendChild(btn);
    if(i===0) btn.classList.add("active");
  });

  function clearActive(){[...rangesEl.children].forEach(b=>b.classList.remove("active"));}

  // live status caches
  const served={}, printed={}, noShow={};

  // live listeners for statuses
  db.ref(`${ROOT}/served`).on("value",s=>{Object.assign(served,s.val()||{}); refreshGridClasses();});
  db.ref(`${ROOT}/printed`).on("value",s=>{Object.assign(printed,s.val()||{}); refreshGridClasses();});
  db.ref(`${ROOT}/noshow`).on("value",s=>{Object.assign(noShow,s.val()||{}); refreshGridClasses();});

  // show range
  let curStart=1, curEnd=100;
  function showRange(a,b,btn){
    clearActive(); btn.classList.add("active");
    curStart=a; curEnd=b;
    gridEl.innerHTML="";
    for(let n=a;n<=b;n++){
      const d=document.createElement("div");
      d.className="cell"; d.textContent=n;
      d.onclick = ()=> serve(n);
      d.ondblclick = ()=> { // double-click black -> white
        if(served[n]){ db.ref(`${ROOT}/served/${n}`).remove(); }
      };
      gridEl.appendChild(d);
    }
    refreshGridClasses();
  }

  function refreshGridClasses(){
    [...gridEl.children].forEach(cell=>{
      const n = parseInt(cell.textContent,10);
      cell.classList.remove("on","no","printed");
      if(served[n]) cell.classList.add("on");
      else if(noShow[n]) cell.classList.add("no");
      else if(printed[n]) cell.classList.add("printed");
    });
  }

  async function serve(n){
    // mark served (black)
    await db.ref(`${ROOT}/served/${n}`).set(true);
    // fetch MRN if any and publish latest for screens
    const mrnSnap = await db.ref(`${ROOT}/mrn/${n}`).get();
    const mrnVal = mrnSnap.exists() ? mrnSnap.val() : null;
    await db.ref(`${ROOT}/latest`).set({number:n, ts:Date.now(), mrn: mrnVal || null});
    nowNum.textContent = n;
    nowMrn.textContent = mrnVal ? `MRN: ${mrnVal}` : "";
    refreshGridClasses();
    // auto-switch range if needed
    if(n===curEnd && curEnd<1000){
      const nextStart=curEnd+1, nextEnd=Math.min(curEnd+100,1000);
      const nextBtn = [...rangesEl.children][Math.floor((nextStart-1)/100)];
      showRange(nextStart,nextEnd,nextBtn);
    }
  }

  // Buttons
  document.getElementById("btnNext").onclick = async ()=>{
    // pick smallest unserved in current range (prefer green first)
    for(let n=curStart;n<=curEnd;n++){
      if(!served[n] && !noShow[n]){ await serve(n); return; }
    }
  };

  document.getElementById("btnNo").onclick = async ()=>{
    const n = parseInt(nowNum.textContent,10);
    if(!n) return;
    await db.ref(`${ROOT}/noshow/${n}`).set(true);
    await db.ref(`${ROOT}/served/${n}`).remove();
    refreshGridClasses();
  };

  document.getElementById("btnReset").onclick = ()=>{
    if(!confirm("Are you sure you want to clear all numbers and restart?")) return;
    db.ref(`${ROOT}/served`).remove();
    db.ref(`${ROOT}/noshow`).remove();
    db.ref(`${ROOT}/printed`).remove();
    db.ref(`${ROOT}/latest`).remove();
    nowNum.textContent="-"; nowMrn.textContent="";
  };

  // reflect latest on this operator panel as well (when this operator serves)
  db.ref(`${ROOT}/latest`).on("value",s=>{
    const v=s.val(); if(!v) return;
    nowNum.textContent=v.number || "-";
    nowMrn.textContent = v.mrn ? `MRN: ${v.mrn}` : "";
  });

  // initial
  showRange(1,100,rangesEl.firstElementChild);
})();
</script>
</body>
</html>
